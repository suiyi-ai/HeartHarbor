# 讯飞虚拟人WebSocket连接问题修复指南

## 问题分析
根据错误日志，主要问题包括：
1. **WebSocket连接失败** - 错误代码1006 "abnormal closure"
2. **Windows环境兼容性问题** - `(env: Windows,mp,1.06.2504030; lib: 3.11.1)`
3. **认证签名生成问题** - HMAC-SHA256签名格式不正确

## 已实施的修复

### 1. WebSocket连接优化
- ✅ 修复URL格式检查，确保使用有效的wss URL
- ✅ 添加Origin请求头解决跨域问题
- ✅ 明确指定HTTP方法为GET
- ✅ 针对Windows环境增加超时时间到30秒

### 2. HMAC-SHA256签名修复
- ✅ 修复签名字符串格式（去除多余的\r字符）
- ✅ 优化CryptoJS编码方式，使用正确的UTF-8编码
- ✅ 添加详细的调试日志输出

### 3. 错误处理优化
- ✅ 添加更详细的错误分类和处理
- ✅ 提供用户友好的错误提示信息

## 使用说明

### 1. 检查API配置
确保在配置面板中检查以下参数：
- App ID: `8b636816`
- API Key: `62911d28b5b7013c52ec2ef3cc3ced71`
- API Secret: `ODcxM2QwNmQxMWQzMTQzYWUwNWNhN2Zm`
- Scene ID: `241473910644805632`
- Avatar ID: `110022006`

### 2. 测试连接
1. 点击"初始化SDK"按钮
2. 观察控制台日志输出
3. 如果连接成功，状态会显示"连接成功"
4. 点击"启动虚拟人"开始交互

### 3. 常见问题排查

#### 如果仍然连接失败：
1. **网络问题**：检查网络连接是否正常
2. **API配置**：确认API Key和Secret是否正确
3. **服务状态**：讯飞服务可能暂时不可用

#### 错误代码说明：
- **1006**：连接异常中断，通常是网络或服务器问题
- **SSL/TLS错误**：证书配置问题
- **超时错误**：网络连接不稳定

## 备用方案

如果直接连接讯飞服务器仍然失败，可以考虑：
1. 使用本地模拟模式进行演示
2. 联系讯飞技术支持确认API状态
3. 检查微信开发者工具的网络配置

## 技术细节

### WebSocket连接流程
1. 生成当前时间戳和认证签名
2. 构建认证URL
3. 建立WebSocket连接
4. 发送启动协议
5. 处理虚拟人响应

### 认证签名格式
```
host: avatar.cn-huadong-1.xf-yun.com
date: Tue, 11 Nov 2025 01:02:59 GMT
GET /v1/interact HTTP/1.1
```

## 联系支持
如果问题持续存在，请联系：
- 讯飞技术支持
- 项目开发团队
- 查看官方文档更新