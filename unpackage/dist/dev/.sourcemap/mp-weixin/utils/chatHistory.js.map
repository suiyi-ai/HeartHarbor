{"version":3,"file":"chatHistory.js","sources":["utils/chatHistory.js"],"sourcesContent":["/**\r\n * 聊天历史记录管理工具\r\n * 支持本地存储和Supabase云存储\r\n */\r\n\r\n// 本地存储键名\r\nconst STORAGE_KEYS = {\r\n  CHAT_SESSIONS: 'ai_chat_sessions',\r\n  CURRENT_SESSION: 'ai_current_session',\r\n  USER_PREFERENCES: 'ai_user_preferences'\r\n}\r\n\r\n// 聊天历史记录管理类\r\nclass ChatHistoryManager {\r\n  constructor() {\r\n    this.sessions = []\r\n    this.currentSession = null\r\n    this.isSupabaseEnabled = false\r\n    this.supabaseClient = null\r\n    this.init()\r\n  }\r\n\r\n  // 初始化\r\n  init() {\r\n    this.loadSessionsFromStorage()\r\n    this.loadCurrentSession()\r\n  }\r\n\r\n  // 从本地存储加载会话列表\r\n  loadSessionsFromStorage() {\r\n    try {\r\n      const sessionsData = uni.getStorageSync(STORAGE_KEYS.CHAT_SESSIONS)\r\n      if (sessionsData) {\r\n        this.sessions = JSON.parse(sessionsData)\r\n      }\r\n    } catch (error) {\r\n      console.error('加载会话列表失败:', error)\r\n      this.sessions = []\r\n    }\r\n  }\r\n\r\n  // 加载当前会话\r\n  loadCurrentSession() {\r\n    try {\r\n      const sessionData = uni.getStorageSync(STORAGE_KEYS.CURRENT_SESSION)\r\n      if (sessionData) {\r\n        this.currentSession = JSON.parse(sessionData)\r\n      }\r\n    } catch (error) {\r\n      console.error('加载当前会话失败:', error)\r\n      this.currentSession = null\r\n    }\r\n  }\r\n\r\n  // 保存会话列表到本地存储\r\n  saveSessionsToStorage() {\r\n    try {\r\n      uni.setStorageSync(STORAGE_KEYS.CHAT_SESSIONS, JSON.stringify(this.sessions))\r\n    } catch (error) {\r\n      console.error('保存会话列表失败:', error)\r\n    }\r\n  }\r\n\r\n  // 保存当前会话到本地存储\r\n  saveCurrentSession() {\r\n    try {\r\n      uni.setStorageSync(STORAGE_KEYS.CURRENT_SESSION, JSON.stringify(this.currentSession))\r\n    } catch (error) {\r\n      console.error('保存当前会话失败:', error)\r\n    }\r\n  }\r\n\r\n  // 创建新会话\r\n  createNewSession(role = 'companion', style = 'friendly') {\r\n    const sessionId = this.generateSessionId()\r\n    const newSession = {\r\n      id: sessionId,\r\n      title: this.generateSessionTitle(),\r\n      role: role,\r\n      style: style,\r\n      messages: [\r\n        {\r\n          role: 'assistant',\r\n          content: this.getWelcomeMessage(role),\r\n          timestamp: Date.now()\r\n        }\r\n      ],\r\n      createdAt: Date.now(),\r\n      updatedAt: Date.now(),\r\n      messageCount: 1\r\n    }\r\n\r\n    this.currentSession = newSession\r\n    this.sessions.unshift(newSession)\r\n    this.saveCurrentSession()\r\n    this.saveSessionsToStorage()\r\n\r\n    return newSession\r\n  }\r\n\r\n  // 生成会话ID\r\n  generateSessionId() {\r\n    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)\r\n  }\r\n\r\n  // 生成会话标题\r\n  generateSessionTitle() {\r\n    const now = new Date()\r\n    const hours = now.getHours()\r\n    let timePeriod = ''\r\n\r\n    if (hours >= 5 && hours < 12) {\r\n      timePeriod = '早晨'\r\n    } else if (hours >= 12 && hours < 18) {\r\n      timePeriod = '下午'\r\n    } else if (hours >= 18 && hours < 22) {\r\n      timePeriod = '晚上'\r\n    } else {\r\n      timePeriod = '深夜'\r\n    }\r\n\r\n    return `${timePeriod}的对话`\r\n  }\r\n\r\n  // 获取欢迎消息\r\n  getWelcomeMessage(role) {\r\n    const messages = {\r\n      companion: '你好！我是你的心灵伙伴，我会用温暖的心倾听你的每一个故事。有什么想和我分享的吗？',\r\n      advisor: '您好！我是您的专业心理顾问，我将用专业的知识为您提供理性的分析和建议。请告诉我您的情况。'\r\n    }\r\n    return messages[role] || messages.companion\r\n  }\r\n\r\n  // 添加消息到当前会话\r\n  addMessage(role, content) {\r\n    if (!this.currentSession) {\r\n      this.createNewSession()\r\n    }\r\n\r\n    const message = {\r\n      role: role,\r\n      content: content,\r\n      timestamp: Date.now()\r\n    }\r\n\r\n    this.currentSession.messages.push(message)\r\n    this.currentSession.updatedAt = Date.now()\r\n    this.currentSession.messageCount = this.currentSession.messages.length\r\n\r\n    // 更新会话标题（如果消息数量较少）\r\n    if (this.currentSession.messageCount <= 3) {\r\n      this.currentSession.title = this.generateSessionTitleFromContent(content)\r\n    }\r\n\r\n    this.saveCurrentSession()\r\n    this.updateSessionInList()\r\n\r\n    return message\r\n  }\r\n\r\n  // 根据消息内容生成会话标题\r\n  generateSessionTitleFromContent(content) {\r\n    const keywords = {\r\n      '压力': '压力释放',\r\n      '焦虑': '焦虑缓解',\r\n      '难过': '情绪疏导',\r\n      '开心': '快乐分享',\r\n      '困惑': '困惑解答',\r\n      '工作': '工作压力',\r\n      '学习': '学习困扰',\r\n      '家庭': '家庭关系',\r\n      '朋友': '朋友关系',\r\n      '睡眠': '睡眠问题'\r\n    }\r\n\r\n    for (const [key, value] of Object.entries(keywords)) {\r\n      if (content.includes(key)) {\r\n        return value\r\n      }\r\n    }\r\n\r\n    return '心理对话'\r\n  }\r\n\r\n  // 更新会话列表中的会话\r\n  updateSessionInList() {\r\n    const index = this.sessions.findIndex(session => session.id === this.currentSession.id)\r\n    if (index !== -1) {\r\n      this.sessions[index] = { ...this.currentSession }\r\n      this.saveSessionsToStorage()\r\n    }\r\n  }\r\n\r\n  // 获取会话列表\r\n  getSessions() {\r\n    return this.sessions.sort((a, b) => b.updatedAt - a.updatedAt)\r\n  }\r\n\r\n  // 获取会话详情\r\n  getSession(sessionId) {\r\n    return this.sessions.find(session => session.id === sessionId)\r\n  }\r\n\r\n  // 切换到指定会话\r\n  switchToSession(sessionId) {\r\n    const session = this.getSession(sessionId)\r\n    if (session) {\r\n      this.currentSession = session\r\n      this.saveCurrentSession()\r\n      return session\r\n    }\r\n    return null\r\n  }\r\n\r\n  // 删除会话\r\n  deleteSession(sessionId) {\r\n    const index = this.sessions.findIndex(session => session.id === sessionId)\r\n    if (index !== -1) {\r\n      this.sessions.splice(index, 1)\r\n      this.saveSessionsToStorage()\r\n\r\n      // 如果删除的是当前会话，创建新会话\r\n      if (this.currentSession && this.currentSession.id === sessionId) {\r\n        this.currentSession = null\r\n        this.createNewSession()\r\n      }\r\n\r\n      return true\r\n    }\r\n    return false\r\n  }\r\n\r\n  // 清空所有会话\r\n  clearAllSessions() {\r\n    this.sessions = []\r\n    this.currentSession = null\r\n    uni.removeStorageSync(STORAGE_KEYS.CHAT_SESSIONS)\r\n    uni.removeStorageSync(STORAGE_KEYS.CURRENT_SESSION)\r\n    return this.createNewSession()\r\n  }\r\n\r\n  // 导出会话数据\r\n  exportSession(sessionId) {\r\n    const session = this.getSession(sessionId)\r\n    if (session) {\r\n      return {\r\n        session: session,\r\n        exportTime: Date.now(),\r\n        format: 'HeartHarbor Chat History'\r\n      }\r\n    }\r\n    return null\r\n  }\r\n\r\n  // 获取统计信息\r\n  getStatistics() {\r\n    const totalSessions = this.sessions.length\r\n    const totalMessages = this.sessions.reduce((sum, session) => sum + session.messageCount, 0)\r\n    const averageMessages = totalSessions > 0 ? Math.round(totalMessages / totalSessions) : 0\r\n\r\n    return {\r\n      totalSessions,\r\n      totalMessages,\r\n      averageMessages,\r\n      lastActive: this.sessions.length > 0 ? this.sessions[0].updatedAt : null\r\n    }\r\n  }\r\n}\r\n\r\n// 创建单例实例\r\nconst chatHistoryManager = new ChatHistoryManager()\r\n\r\n// 导出工具函数\r\nexport default {\r\n  // 会话管理\r\n  createNewSession: (role, style) => chatHistoryManager.createNewSession(role, style),\r\n  getSessions: () => chatHistoryManager.getSessions(),\r\n  getSession: (sessionId) => chatHistoryManager.getSession(sessionId),\r\n  switchToSession: (sessionId) => chatHistoryManager.switchToSession(sessionId),\r\n  deleteSession: (sessionId) => chatHistoryManager.deleteSession(sessionId),\r\n  clearAllSessions: () => chatHistoryManager.clearAllSessions(),\r\n\r\n  // 消息管理\r\n  addMessage: (role, content) => chatHistoryManager.addMessage(role, content),\r\n  getCurrentSession: () => chatHistoryManager.currentSession,\r\n\r\n  // 数据管理\r\n  exportSession: (sessionId) => chatHistoryManager.exportSession(sessionId),\r\n  getStatistics: () => chatHistoryManager.getStatistics(),\r\n\r\n  // 工具函数\r\n  formatTime: (timestamp) => {\r\n    const date = new Date(timestamp)\r\n    const now = new Date()\r\n    const diff = now - date\r\n\r\n    if (diff < 60000) { // 1分钟内\r\n      return '刚刚'\r\n    } else if (diff < 3600000) { // 1小时内\r\n      return Math.floor(diff / 60000) + '分钟前'\r\n    } else if (diff < 86400000) { // 1天内\r\n      return Math.floor(diff / 3600000) + '小时前'\r\n    } else if (diff < 604800000) { // 1周内\r\n      return Math.floor(diff / 86400000) + '天前'\r\n    } else {\r\n      return date.toLocaleDateString()\r\n    }\r\n  },\r\n\r\n  // 会话标题生成器\r\n  generateTitleFromContent: (content) => {\r\n    if (content.length <= 10) return content\r\n    return content.substring(0, 10) + '...'\r\n  }\r\n}"],"names":["uni"],"mappings":"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"}